##################################################################################
#         About
##################################################################################
# Reuseable workflow to be called from content repos.
# Build and deploy app bundle for ios
#
#         Version : 1.1
#
##################################################################################
#         Configuration
##################################################################################
env:
  DEPLOYMENT_PRIVATE_KEY: ${{secrets.DEPLOYMENT_PRIVATE_KEY}}

  GOOGLE_SERVICES_JSON: ${{secrets.GOOGLE_SERVICES_JSON}}
  GOOGLE_SERVICES_PLIST: ${{secrets.GOOGLE_SERVICES_PLIST}}

  # Required for this action
  APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
  APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
  APP_STORE_TEAM_ID: ${{ vars.APP_STORE_TEAM_ID }}
  GCP_IOS_CERTS_SERVICE_ACCOUNT_KEY: ${{secrets.GCP_IOS_CERTS_SERVICE_ACCOUNT_KEY}}
  GCP_IOS_CERTS_BUCKET_ID: ${{ vars.GCP_IOS_CERTS_BUCKET_ID }}
  GCP_IOS_CERTS_ENCRYPTION_PASSWORD: ${{ secrets.GCP_IOS_CERTS_ENCRYPTION_PASSWORD }}
  GCP_IOS_CERTS_PROJECT_ID: ${{ vars.GCP_IOS_CERTS_PROJECT_ID }}

  # Optional (if deploying to appetize)
  APPETIZE_TOKEN: ${{secrets.APPETIZE_TOKEN}}

  ##################################################################################
  #         Main Code
  ##################################################################################
name:
  IOS Release

  # Only keep one active build per ref (e.g. pr branch, push branch, triggering workflow ref)
concurrency:
  group: ios-release-${{ github.workflow }}-${{ github.ref }}-${{ inputs.target }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
      CONTENT_BRANCH:
        type: string
        description: "Specify branch for deployment"
        default: ""
      target:
        type: string
        description: testflight / appetize
        default: testflight
      LFS_USED:
        default: false
        type: boolean  
      APP_CODE_BRANCH:
        required: true
        type: string
      DEPLOYMENT_NAME:
        required: true
        type: string
      PARENT_DEPLOYMENT_NAME:
        type: string
        default: ""
      PARENT_DEPLOYMENT_REPO:
        type: string
        default: ""
      PARENT_DEPLOYMENT_BRANCH:
        type: string
        default: ""
      ENCRYPTED:
        required: true
        type: boolean
    secrets:
      DEPLOYMENT_PRIVATE_KEY:
        description: Provide private key if deployment uses encrypted config
      GOOGLE_SERVICES_JSON:
        description: Google Services JSON configuration file
      GOOGLE_SERVICES_PLIST:
        description: Google Services PLIST configuration file
      APP_STORE_CONNECT_API_KEY_ID:
        description: App Store Connect API Key ID
      APP_STORE_CONNECT_API_ISSUER_ID:
        description: App Store Connect API Issuer ID
      APP_STORE_CONNECT_API_KEY:
        description: App Store Connect API Key (private key content)
      GCP_IOS_CERTS_SERVICE_ACCOUNT_KEY:
        description: GCP service account key for iOS certificates bucket access
      GCP_IOS_CERTS_ENCRYPTION_PASSWORD:
        description: Password for encrypting/decrypting iOS certificates
      APPETIZE_TOKEN:
        description: Appetize API token (optional, required if target is appetize)

jobs:
  # Ensure all required secrets are populated
  validate_env:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          for var in APP_STORE_CONNECT_API_KEY_ID APP_STORE_CONNECT_API_ISSUER_ID APP_STORE_CONNECT_API_KEY GCP_IOS_CERTS_ENCRYPTION_PASSWORD GCP_IOS_CERTS_SERVICE_ACCOUNT_KEY; do
            if [ -z "$(printenv "$var")" ]; then
              echo "❌ Missing required secret: $var"
              exit 1
            else
              echo "✅ $var is set"
            fi
          done
      - name: Validate required variables
        run: |
          set -euo pipefail
          for var in APP_STORE_TEAM_ID GCP_IOS_CERTS_BUCKET_ID GCP_IOS_CERTS_PROJECT_ID; do
            if [ -z "${!var}" ]; then
              echo "❌ Missing required variable: $var"
              exit 1
            else
              echo "✅ $var is set"
            fi
          done
      - name: Validate release target
        run: |
          case "${{ inputs.target }}" in
            testflight|appetize) echo "✅ Valid target: ${{ inputs.target }}" ;;
            *) echo "❌ Invalid target: ${{ inputs.target }}"; exit 1 ;;
          esac
  #############################################################################
  #         Build Deployment Web
  #############################################################################

  build_web:
    uses: ./.github/workflows/app-build.yml
    needs: validate_env
    with:
      CONTENT_BRANCH: ${{ inputs.CONTENT_BRANCH }}
      LFS_USED: ${{ inputs.LFS_USED }}
      APP_CODE_BRANCH: ${{ inputs.APP_CODE_BRANCH }}
      DEPLOYMENT_NAME: ${{ inputs.DEPLOYMENT_NAME }}
      PARENT_DEPLOYMENT_NAME: ${{ inputs.PARENT_DEPLOYMENT_NAME }}
      PARENT_DEPLOYMENT_REPO: ${{ inputs.PARENT_DEPLOYMENT_REPO }}
      PARENT_DEPLOYMENT_BRANCH: ${{ inputs.PARENT_DEPLOYMENT_BRANCH }}
      ENCRYPTED: ${{ inputs.ENCRYPTED }}
    secrets:
      DEPLOYMENT_PRIVATE_KEY: ${{ secrets.DEPLOYMENT_PRIVATE_KEY }}

  #############################################################################
  #         Build IOS
  #############################################################################

  build_ios:
    name: Build iOS and Release to ${{ inputs.target }}
    # As of April 2026, App Store Connect requires iOS 26.x SDK, i.e. Xcode 26.x, which is default for macos-26 runner image
    # Will need manually updating in future to match Apple's requirements. See https://github.com/actions/runner-images
    runs-on: macos-26
    needs: build_web
    steps:
      # Checkout builder repo and install node_modules so that they can be used in ios build
      # (e.g. capacitor plugins store podfiles in node_modules)
      - uses: actions/checkout@v4
        with:
          repository: "IDEMSInternational/open-app-builder.git"
          ref: ${{inputs.APP_CODE_BRANCH}}

      - name: Checkout parent repo if needed
        if: inputs.PARENT_DEPLOYMENT_REPO != ''
        uses: actions/checkout@v4
        with:
          path: ".idems_app/deployments/${{inputs.PARENT_DEPLOYMENT_NAME}}"
          repository: ${{inputs.PARENT_DEPLOYMENT_REPO}}
          ref: ${{inputs.PARENT_DEPLOYMENT_BRANCH}}
          lfs: false

      - name: Checkout deployment
        uses: actions/checkout@v4
        with:
          ref: ${{inputs.CONTENT_BRANCH}}
          path: ".idems_app/deployments/${{inputs.DEPLOYMENT_NAME}}"
          fetch-depth: 0
          lfs: ${{inputs.LFS_USED}}

      - name: Populate Encryption key
        if: inputs.ENCRYPTED
        run: echo "${{secrets.DEPLOYMENT_PRIVATE_KEY}}" > ./.idems_app/deployments/${{inputs.DEPLOYMENT_NAME}}/encrypted/private.key

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.17.0

      - uses: actions/cache/restore@v4
        id: cache
        with:
          path: ./.yarn/cache
          key: ${{ runner.os }}-node-modules-yarn-v1-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-yarn-v1-
      - name: Install node modules
        run: yarn install --immutable
      - uses: actions/cache/save@v4
        if: steps.cache.outputs.cache-hit != 'true'
        with:
          path: ./.yarn/cache
          key: ${{ runner.os }}-node-modules-yarn-v1-${{ hashFiles('yarn.lock') }}

      - name: Set deployment
        run: yarn workflow deployment set ${{inputs.DEPLOYMENT_NAME}} --skip-refresh

      - name: Download www artifact
        uses: actions/download-artifact@v4
        with:
          name: www

      - name: Extract www folder
        run: |
          mkdir -p www
          tar -xf artifact.tar --directory www

      - name: Write GoogleService-Info.plist
        run: |
          mkdir -p ios/App/App
          printenv GOOGLE_SERVICES_PLIST > ios/App/App/GoogleService-Info.plist
        env:
          GOOGLE_SERVICES_PLIST: ${{ secrets.GOOGLE_SERVICES_PLIST }}

      - name: Configure iOS
        run: |
          yarn workflow ios configure
          npx cap sync ios

      # Setup ruby. Use bundler-cache to auto-install Gemfile in working directory
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"
          bundler-cache: true
          working-directory: ios/App

      # Install node_module dependencies (includes capacitor plugin pods required for build)
      - uses: actions/setup-node@v4
        with:
          node-version: 20.17.0
          cache: yarn
      - run: yarn workspaces focus frontend --production

      # Setup certs, build and upload to target (testflight or appetize)
      - name: Build IOS and Release to ${{ inputs.target }}
        working-directory: ios/App
        # Call workflow from generated fastfile
        run: bundle exec fastlane release_${{ inputs.target }}

      # Upload logs if the job fails
      - name: Upload Xcode build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-build-logs
          path: ~/Library/Logs/gym

